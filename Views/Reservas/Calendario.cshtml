@{
    ViewData["Title"] = "Calendario de Reservas";
    var restauranteId = ViewBag.RestauranteId;
    var restauranteNombre = ViewBag.RestauranteNombre;
}

<style>
    .calendar-container {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    .stats-card {
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        transition: transform 0.3s;
    }
    .stats-card:hover {
        transform: translateY(-5px);
    }
    .fc-event {
        cursor: pointer;
    }
    .disponibilidad-item {
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s;
    }
    .disponibilidad-item:hover {
        transform: translateX(5px);
    }
    .disponibilidad-item.disponible {
        background: #d4edda;
        border-left: 4px solid #28a745;
    }
    .disponibilidad-item.lleno {
        background: #f8d7da;
        border-left: 4px solid #dc3545;
    }
</style>

<div class="container-fluid py-5">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="fw-bold mb-2">
                        <i class="bi bi-calendar-week text-primary"></i> 
                        Calendario de Reservas
                    </h2>
                    <p class="text-muted mb-0">@restauranteNombre</p>
                </div>
                <div>
                    <a asp-action="Index" class="btn btn-outline-secondary me-2">
                        <i class="bi bi-arrow-left"></i> Volver
                    </a>
                    <a asp-action="Create" asp-route-restauranteId="@restauranteId" 
                       class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Nueva Reserva
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card stats-card border-0 bg-primary text-white">
                <i class="bi bi-calendar-check fs-1 mb-2"></i>
                <h3 class="mb-1" id="reservasHoy">0</h3>
                <small>Reservas Hoy</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card border-0 bg-success text-white">
                <i class="bi bi-people fs-1 mb-2"></i>
                <h3 class="mb-1" id="personasHoy">0</h3>
                <small>Personas Hoy</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card border-0 bg-info text-white">
                <i class="bi bi-calendar-month fs-1 mb-2"></i>
                <h3 class="mb-1" id="reservasMes">0</h3>
                <small>Reservas del Mes</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card border-0 bg-warning text-dark">
                <i class="bi bi-graph-up fs-1 mb-2"></i>
                <h3 class="mb-1" id="personasMes">0</h3>
                <small>Personas del Mes</small>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Calendario Principal -->
        <div class="col-lg-8">
            <div class="calendar-container">
                <div id="calendar"></div>
            </div>
        </div>

        <!-- Panel Lateral -->
        <div class="col-lg-4">
            <!-- Disponibilidad del Día -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-clock"></i> Disponibilidad
                    </h5>
                </div>
                <div class="card-body" id="disponibilidadPanel">
                    <p class="text-muted text-center">
                        Selecciona una fecha en el calendario
                    </p>
                </div>
            </div>

            <!-- Horas Más Populares -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up"></i> Horas Populares
                    </h5>
                </div>
                <div class="card-body">
                    <div id="horasPopulares">
                        <p class="text-muted text-center">Cargando...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Detalle de Evento -->
<div class="modal fade" id="eventoModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-info-circle"></i> Detalle de Reserva
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="eventoDetalle">
                <!-- Se llenará con JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales/es.global.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const restauranteId = @restauranteId;
            const calendarEl = document.getElementById('calendar');
            let calendar;

            // Inicializar calendario
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'es',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                buttonText: {
                    today: 'Hoy',
                    month: 'Mes',
                    week: 'Semana',
                    day: 'Día'
                },
                events: function(info, successCallback, failureCallback) {
                    fetch(`/api/Calendario/eventos/${restauranteId}?start=${info.startStr}&end=${info.endStr}`)
                        .then(response => response.json())
                        .then(data => {
                            successCallback(data);
                        })
                        .catch(error => {
                            console.error('Error cargando eventos:', error);
                            failureCallback(error);
                        });
                },
                eventClick: function(info) {
                    mostrarDetalleEvento(info.event);
                },
                dateClick: function(info) {
                    cargarDisponibilidad(info.dateStr);
                },
                datesSet: function(info) {
                    cargarEstadisticas(info.start);
                }
            });

            calendar.render();

            // Cargar estadísticas iniciales
            cargarEstadisticas(new Date());

            function cargarEstadisticas(fecha) {
                const fechaStr = fecha.toISOString().split('T')[0];
                
                fetch(`/api/Calendario/estadisticas/${restauranteId}?fecha=${fechaStr}`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('reservasHoy').textContent = data.totalReservasHoy;
                        document.getElementById('personasHoy').textContent = data.personasHoy;
                        document.getElementById('reservasMes').textContent = data.totalReservasMes;
                        document.getElementById('personasMes').textContent = data.personasMes;

                        // Actualizar horas populares
                        const horasHTML = data.horasMasPopulares.map(h => `
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                                <span><i class="bi bi-clock text-primary"></i> ${h.hora}</span>
                                <span class="badge bg-success">${h.cantidad} reservas</span>
                            </div>
                        `).join('');
                        
                        document.getElementById('horasPopulares').innerHTML = horasHTML || 
                            '<p class="text-muted text-center">No hay datos</p>';
                    })
                    .catch(error => {
                        console.error('Error cargando estadísticas:', error);
                    });
            }

            function cargarDisponibilidad(fecha) {
                fetch(`/api/Calendario/disponibilidad/${restauranteId}?fecha=${fecha}`)
                    .then(response => response.json())
                    .then(data => {
                        const panel = document.getElementById('disponibilidadPanel');
                        
                        const horariosHTML = data.horarios.map(h => {
                            const claseDisp = h.disponible ? 'disponible' : 'lleno';
                            const icono = h.disponible ? 
                                '<i class="bi bi-check-circle-fill text-success"></i>' : 
                                '<i class="bi bi-x-circle-fill text-danger"></i>';
                            
                            return `
                                <div class="disponibilidad-item ${claseDisp}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>${icono} ${h.hora}</span>
                                        <span class="badge ${h.disponible ? 'bg-success' : 'bg-danger'}">
                                            ${h.capacidadDisponible} disponibles
                                        </span>
                                    </div>
                                </div>
                            `;
                        }).join('');

                        panel.innerHTML = `
                            <h6 class="mb-3">
                                <i class="bi bi-calendar3"></i> 
                                ${new Date(fecha).toLocaleDateString('es-ES', { 
                                    weekday: 'long', 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric' 
                                })}
                            </h6>
                            ${horariosHTML}
                        `;
                    })
                    .catch(error => {
                        console.error('Error cargando disponibilidad:', error);
                        document.getElementById('disponibilidadPanel').innerHTML = `
                            <div class="alert alert-danger">
                                Error cargando disponibilidad
                            </div>
                        `;
                    });
            }

            function mostrarDetalleEvento(evento) {
                const props = evento.extendedProps;
                const fecha = new Date(evento.start);
                
                const detalleHTML = `
                    <div class="mb-3">
                        <strong>Código de Reserva:</strong><br>
                        <span class="badge bg-primary fs-6">${props.codigoReserva}</span>
                    </div>
                    <div class="mb-3">
                        <strong>Fecha y Hora:</strong><br>
                        ${fecha.toLocaleDateString('es-ES')} - ${fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}
                    </div>
                    <div class="mb-3">
                        <strong>Número de Personas:</strong><br>
                        <i class="bi bi-people-fill"></i> ${props.numeroPersonas} personas
                    </div>
                    <div class="mb-3">
                        <strong>Estado:</strong><br>
                        <span class="badge ${props.estado === 'Confirmada' ? 'bg-success' : 'bg-warning'}">${props.estado}</span>
                    </div>
                    ${props.notasEspeciales ? `
                        <div class="mb-3">
                            <strong>Notas Especiales:</strong><br>
                            <p class="text-muted">${props.notasEspeciales}</p>
                        </div>
                    ` : ''}
                `;
                
                document.getElementById('eventoDetalle').innerHTML = detalleHTML;
                new bootstrap.Modal(document.getElementById('eventoModal')).show();
            }
        });
    </script>
}